{"version":3,"file":"asset-checksum.js","sourceRoot":"","sources":["../../../src/cli/utilities/asset-checksum.ts"],"names":[],"mappings":"AAAA,OAAO,EAAC,YAAY,EAAE,MAAM,EAAE,aAAa,EAAE,UAAU,EAAC,MAAM,eAAe,CAAA;AAC7E,OAAO,EAAC,QAAQ,EAAC,MAAM,8BAA8B,CAAA;AAErD,MAAM,CAAC,KAAK,UAAU,QAAQ,CAAC,IAAY,EAAE,IAAY;IACvD,IAAI,OAAO,GAAG,MAAM,aAAa,CAAC,IAAI,EAAE,IAAI,CAAC,CAAA;IAE7C,IAAI,CAAC,OAAO;QAAE,OAAO,EAAE,CAAA;IAEvB,IAAI,UAAU,CAAC,IAAI,CAAC;QAAE,OAAO,GAAG,OAAO,CAAC,OAAO,CAAC,OAAO,EAAE,IAAI,CAAC,CAAA;IAE9D,IAAI,MAAM,CAAC,IAAI,CAAC,EAAE;QAChB,OAAO,GAAG,aAAa,CAAC,OAAO,CAAC,CAAA;QAEhC;;;;;;;WAOG;QACH,IAAI,CAAC,YAAY,CAAC,IAAI,CAAC,EAAE;YACvB,OAAO,GAAG,OAAO,CAAC,OAAO,CAAC,YAAY,EAAE,KAAK,CAAC,CAAA;SAC/C;KACF;IAED,OAAO,GAAG,CAAC,OAAO,CAAC,CAAA;AACrB,CAAC;AAED,MAAM,UAAU,aAAa,CAAC,OAAe;IAC3C,IAAI,KAAK,GAAG,KAAK,CAAA;IACjB,IAAI,YAAY,GAAG,KAAK,CAAA;IACxB,IAAI,YAAY,GAAG,EAAE,CAAA;IAErB,KAAK,MAAM,IAAI,IAAI,OAAO,EAAE;QAC1B,IAAI,IAAI,KAAK,GAAG,IAAI,CAAC,YAAY,EAAE;YACjC,KAAK,GAAG,CAAC,KAAK,CAAA;SACf;QAED,IAAI,CAAC,KAAK,IAAI,CAAC,IAAI,KAAK,GAAG,IAAI,IAAI,KAAK,IAAI,CAAC,EAAE;YAC7C,SAAQ;SACT;QAED,YAAY,IAAI,IAAI,CAAA;QACpB,YAAY,GAAG,IAAI,KAAK,IAAI,IAAI,CAAC,YAAY,CAAA;KAC9C;IAED,OAAO,YAAY,CAAA;AACrB,CAAC;AAED,SAAS,GAAG,CAAC,OAAe;IAC1B,MAAM,MAAM,GAAG,MAAM,CAAC,IAAI,CAAC,OAAO,CAAC,CAAA;IAEnC,OAAO,QAAQ,CAAC,MAAM,CAAC,CAAA;AACzB,CAAC","sourcesContent":["import {isThemeAsset, isJson, readThemeFile, isTextFile} from './theme-fs.js'\nimport {fileHash} from '@shopify/cli-kit/node/crypto'\n\nexport async function checksum(root: string, path: string) {\n  let content = await readThemeFile(root, path)\n\n  if (!content) return ''\n\n  if (isTextFile(path)) content = content.replace(/\\r\\n/g, '\\n')\n\n  if (isJson(path)) {\n    content = normalizeJson(content)\n\n    /**\n     * The backend (Assets API) escapes forward slashes for internal JSON\n     * assets such as templates/*.json, sections/*.json, config/*.json.\n     *\n     * To maintain consistency in checksum calculation, we follow the same\n     * approach here (note that already escaped forward slashes are not\n     * re-escaped).\n     */\n    if (!isThemeAsset(path)) {\n      content = content.replace(/(?<!\\\\)\\//g, '\\\\/')\n    }\n  }\n\n  return md5(content)\n}\n\nexport function normalizeJson(jsonStr: string) {\n  let inStr = false\n  let wasBackslash = false\n  let formattedStr = ''\n\n  for (const char of jsonStr) {\n    if (char === '\"' && !wasBackslash) {\n      inStr = !inStr\n    }\n\n    if (!inStr && (char === ' ' || char === '\\n')) {\n      continue\n    }\n\n    formattedStr += char\n    wasBackslash = char === '\\\\' && !wasBackslash\n  }\n\n  return formattedStr\n}\n\nfunction md5(content: string) {\n  const buffer = Buffer.from(content)\n\n  return fileHash(buffer)\n}\n"]}